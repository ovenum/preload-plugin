import e from"@swup/plugin";import{getCurrentUrl as t,Location as o}from"swup";function s(){return window.matchMedia("(hover: hover)").matches}const r=window.requestIdleCallback||(e=>setTimeout(e,1));class i extends e{constructor(e){void 0===e&&(e={}),super();const t=this;this.name="SwupPreloadPlugin",this.requires={swup:">=4"},this.defaults={throttle:5,preloadInitialPage:!0,preloadHoveredLinks:!0,preloadVisibleLinks:{enabled:!1,threshold:.2,delay:500,containers:["body"],ignore:()=>!1}},this.options=void 0,this.queue=void 0,this.preloadObserver=void 0,this.preloadPromises=new Map,this.mouseEnterDelegate=void 0,this.touchStartDelegate=void 0,this.focusDelegate=void 0,this.onPageLoad=(e,t,o)=>{const{url:s}=e.to;return s&&this.preloadPromises.has(s)?this.preloadPromises.get(s):o(e,t)},this.onMouseEnter=function(e){try{if(e.target!==e.delegateTarget)return Promise.resolve();if(!s())return Promise.resolve();const o=e.delegateTarget;return o instanceof HTMLAnchorElement?(t.swup.hooks.callSync("link:hover",{el:o,event:e}),t.preload(o,{priority:!0}),Promise.resolve()):Promise.resolve()}catch(e){return Promise.reject(e)}},this.onTouchStart=e=>{if(s())return;const t=e.delegateTarget;t instanceof HTMLAnchorElement&&this.preload(t,{priority:!0})},this.onFocus=e=>{const t=e.delegateTarget;t instanceof HTMLAnchorElement&&this.preload(t,{priority:!0})};const{preloadVisibleLinks:o,...r}=e;this.options={...this.defaults,...r},"object"==typeof o?this.options.preloadVisibleLinks={...this.options.preloadVisibleLinks,enabled:!0,...o}:this.options.preloadVisibleLinks.enabled=Boolean(o),this.preload=this.preload.bind(this),this.queue=function(e){void 0===e&&(e=1);const t=[],o=[];let s=0,r=0;function i(){r<e&&s>0&&((o.shift()||t.shift()||(()=>{}))(),s--,r++)}return{add:function(e,r){if(void 0===r&&(r=!1),e.__queued){if(!r)return;{const o=t.indexOf(e);if(o>=0){const e=t.splice(o,1);s-=e.length}}}e.__queued=!0,(r?o:t).push(e),s++,s<=1&&i()},next:function(){r--,i()}}}(this.options.throttle)}mount(){const e=this.swup;e.options.cache?(e.hooks.create("page:preload"),e.hooks.create("link:hover"),e.preload=this.preload,e.preloadLinks=this.preloadLinks,this.replace("page:load",this.onPageLoad),this.preloadLinks(),this.on("page:view",()=>this.preloadLinks()),this.options.preloadVisibleLinks.enabled&&(this.preloadVisibleLinks(),this.on("page:view",()=>this.preloadVisibleLinks())),this.options.preloadHoveredLinks&&this.preloadLinksOnAttention(),this.options.preloadInitialPage&&this.preload(t())):console.warn("SwupPreloadPlugin: swup cache needs to be enabled for preloading")}unmount(){this.swup.preload=void 0,this.swup.preloadLinks=void 0,this.preloadPromises.clear(),this.mouseEnterDelegate?.destroy(),this.touchStartDelegate?.destroy(),this.focusDelegate?.destroy(),this.stopPreloadingVisibleLinks()}preload(e,t){void 0===t&&(t={});try{const s=this;let r,i;const n=t.priority??!1;if(Array.isArray(e))return Promise.all(e.map(e=>s.preload(e)));if(e instanceof HTMLAnchorElement)i=e,({url:r}=o.fromElement(e));else{if("string"!=typeof e)return Promise.resolve();r=e}if(s.preloadPromises.has(r))return Promise.resolve(s.preloadPromises.get(r));if(!s.shouldPreload(r,{el:i}))return Promise.resolve();const a=new Promise(e=>{s.queue.add(()=>{s.performPreload(r).catch(()=>{}).then(t=>e(t)).finally(()=>{s.queue.next(),s.preloadPromises.delete(r)})},n)});return s.preloadPromises.set(r,a),Promise.resolve(a)}catch(e){return Promise.reject(e)}}preloadLinks(){r(()=>{Array.from(document.querySelectorAll("a[data-swup-preload], [data-swup-preload-all] a")).forEach(e=>this.preload(e))})}preloadLinksOnAttention(){const{swup:e}=this,{linkSelector:t}=e.options,o={passive:!0,capture:!0};this.mouseEnterDelegate=e.delegateEvent(t,"mouseenter",this.onMouseEnter,o),this.touchStartDelegate=e.delegateEvent(t,"touchstart",this.onTouchStart,o),this.focusDelegate=e.delegateEvent(t,"focus",this.onFocus,o)}preloadVisibleLinks(){if(this.preloadObserver)return void this.preloadObserver.update();const{threshold:e,delay:t,containers:o}=this.options.preloadVisibleLinks;this.preloadObserver=function(e){let{threshold:t,delay:o,containers:s,callback:i,filter:n}=e;const a=new Map,l=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?d(e.target):h(e.target)})},{threshold:t}),d=e=>{const t=a.get(e.href)??new Set;a.set(e.href,t),t.add(e),setTimeout(()=>{const t=a.get(e.href);t?.size&&(i(e),l.unobserve(e),t.delete(e))},o)},h=e=>a.get(e.href)?.delete(e),p=()=>{r(()=>{const e=s.map(e=>`${e} a[href]`).join(", ");Array.from(document.querySelectorAll(e)).filter(e=>n(e)).forEach(e=>l.observe(e))})};return{start:()=>p(),stop:()=>l.disconnect(),update:()=>(a.clear(),p())}}({threshold:e,delay:t,containers:o,callback:e=>this.preload(e),filter:e=>!this.options.preloadVisibleLinks.ignore(e)&&this.shouldPreload(e.href,{el:e})}),this.preloadObserver.start()}stopPreloadingVisibleLinks(){this.preloadObserver&&this.preloadObserver.stop()}shouldPreload(e,s){let{el:r}=void 0===s?{}:s;const{url:i,href:n}=o.fromUrl(e);return!(!function(){if(navigator.connection){if(navigator.connection.saveData)return!1;if(navigator.connection.effectiveType?.endsWith("2g"))return!1}return!0}()||this.swup.cache.has(i)||this.preloadPromises.has(i)||this.swup.shouldIgnoreVisit(n,{el:r})||r&&this.swup.resolveUrl(i)===this.swup.resolveUrl(t()))}performPreload(e){try{const t=this;return Promise.resolve(t.swup.fetchPage(e)).then(function(e){return Promise.resolve(t.swup.hooks.call("page:preload",{page:e})).then(function(){return e})})}catch(e){return Promise.reject(e)}}}export{i as default};
//# sourceMappingURL=index.module.js.map
